---
title: 提交代码之前格式化，你会吗
comments: true
cover: cover.png
date: 2022-02-19 16:32:23
categories:
- Fastapi
keyword: 静态代码,格式化,flake8,pre-commit,autoflake,isort,black
tags:
- 原创
---

一个项目整体的代码，拥有统一并且规范的代码风格无疑是非常重要的，特别是在使用Python这种动态语言开发的项目中。
<!-- more -->

# 静态代码格式化
> 为了在团队内部统一Python项目代码规范，借助pre-commit整合工具链，强制落地项目代码规范，实现在本地在提交代码时，根据已经设置好的的格式化规则自动格式化代码，显著提升团队的协同开发效率，以及降低bug产生概率。

## pre-commit
pre-commit 是整个工作流最重要的一环，它是 git-hooks 中的一个重要的钩子，在键入提交信息前运行，常用于检查即将提交的快照，如果该钩子以非零值退出，Git 将放弃此次提交。

## 有哪些hook呢
- isort：规范 python 库导入顺序，并且对不同类型的pkg进行分组， 支持配置文件自定义规则。
- black：代码格式化工具，支持配置文件自定义规则。
- flake8：综合代码静态分析工具，用于检查代码风格、语法错误和一些常见的编码问题，主要关注代码的风格和语法问题，例如缩进、空格、行长度、命名约定等。
- autoflake：用于自动化修复Python代码中的一些问题，例如删除未使用的导入(import)语句、删除无效的变量和代码行、移除未使用的代码等。
- check-ast：分析Python代码的抽象语法树，实现代码验证、规范检查、重构优化、安全性分析和依赖关系分析等功能。
- check-byte-order-marker：检查文本文件中的字节顺序标记（BOM）。
- check-case-conflict：扫描代码库的文件名和路径，检查代码库中的文件名和路径的大小写冲突。
- check-docstring-first：检查Python函数或方法的文档字符串（docstring）是否在定义的时候放置在首行。
- check-executables-have-shebangs：检查可执行文件是否包含正确的 shebang。
- check-json：检查 JSON 数据的有效性和格式正确性。
- check-yaml：检查 YAML 数据的有效性和格式正确性。
- debug-statements：检查代码库中是否存在调试语句（debug statements），并在提交之前阻止这些调试语句的提交。
- detect-private-key：检测代码库中是否包含私密密钥文件，并在提交之前阻止这些文件的提交。
- end-of-file-fixer：在提交之前自动修复文件末尾的行尾字符（end-of-file character）。
- trailing-whitespace：检测和修复代码库中的行尾多余空白字符（trailing whitespace）。
- mixed-line-ending：检测和修复代码库中混合使用的行尾字符（line endings）。

## 安装依赖

### 命令行安装
```python
pip3 install pre-commit autoflake black isort flake8
```

### requirements.txt安装
requirements.txt 准备依赖如下：
- autoflake==1.4
- black==22.8.0
- isort==5.10.1
- pre-commit==2.17.0
- flake8==5.0.4

```python
pip3 install -r requirements.txt
```

## 配置
### 1. 根目录终端执行pre-commit install，此时.git/hooks/pre-commit被覆盖
```bash
#!/usr/bin/env bash
# File generated by pre-commit: https://pre-commit.com

# start templated
INSTALL_PYTHON=/usr/local/opt/python@3.9/bin/python3.9
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=pre-commit)
# end templated

HERE="$(cd "$(dirname "$0")" && pwd)"
ARGS+=(--hook-dir "$HERE" -- "$@")

if [ -x "$INSTALL_PYTHON" ]; then
    exec "$INSTALL_PYTHON" -mpre_commit "${ARGS[@]}"
elif command -v pre-commit > /dev/null; then
    exec pre-commit "${ARGS[@]}"
else
    echo '`pre-commit` not found.  Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
```
上述代码指明config读取自根目录下的.pre-commit-config.yaml文件

### 2. 设置 .git可见
.git文件夹是不可见的，vscode工具已设置为不可见
```json
{
  "files.exclude": 
  {
    "**/.git": true,
    "**/.svn": true,
    "**/.hg": true,
    "**/CVS": true,
    "**/Thumbs.db": true
  }
}
```
此时你可以更改"**/.git": false，vacode即可见.git文件夹

### 3. 根目录新建.pre-commit-config.yaml并配置
```yaml
repos:
  - repo: local
    hooks:
      - id: autoflake
        name: 移除不使用的变量和导入模块
        entry: bash -c 'autoflake "$@"; git add -u' --
        language: python
        args:
          [
            "--in-place",
            "--remove-all-unused-imports",
            "--remove-unused-variables",
            "--expand-star-imports",
            "--ignore-init-module-imports",
          ]
        files: \.py$
      - id: isort
        name: 导入模块排序
        entry: bash -c 'isort "$@"; git add -u' --
        language: python
        args: ["--filter-files"]
        files: \.py$
      - id: black
        name: 格式化python代码
        entry: bash -c 'black "$@"; git add -u' --
        language: python
        types: [python]
        args: ["--line-length=120"]
      - id: flake8
        name: 综合代码静态分析工具，用于检查代码风格、语法错误和一些常见的编码问题
        entry: bash -c 'flake8 "$@"; git add -u' --
        language: python
        args: ["--max-line-length=120", "--ignore=E303,E731,W191,W504,E402", "--exclude=__init__.py"]
```
上述代码指明根据本地的hooks配置来做校验和格式化

## 如何使用

### 将本地所有文件格式化
```bash
pre-commit run --all-files
```
![格式化](log.png)

### 提交代码自动格式化

<font color="red">注意：首次耗时会比较长</font>
